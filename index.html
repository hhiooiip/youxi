<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Mosaic | C语言逻辑构建</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* 现代霓虹配色 */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            
            --text-white: #ffffff;
            --text-gray: #a0a0a0;
            
            --accent-green: #00e676;
            --accent-blue: #2979ff;
            --accent-red: #ff1744;
            
            /* 代码高亮 (One Dark Pro 风格) */
            --c-keyword: #c678dd;
            --c-func: #61afef;
            --c-string: #98c379;
            --c-num: #d19a66;
            --c-macro: #e5c07b;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: #0f0c29;
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            color: var(--text-white);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            padding: 20px;
        }

        /* 动态背景光斑 */
        .ambient-light {
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(118,75,162,0.4) 0%, rgba(0,0,0,0) 70%);
            top: -100px;
            left: -100px;
            z-index: -1;
            animation: float 10s infinite ease-in-out;
        }
        .ambient-light:nth-child(2) {
            top: auto; bottom: -150px; left: auto; right: -100px;
            background: radial-gradient(circle, rgba(102,126,234,0.3) 0%, rgba(0,0,0,0) 70%);
            animation: float 15s infinite ease-in-out reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, 50px); }
        }

        /* 主卡片容器 */
        .app-container {
            width: 100%;
            max-width: 700px;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--glass-shadow);
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            transition: transform 0.3s;
        }

        /* 头部 */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-badge {
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            border: 1px solid var(--glass-border);
            color: var(--accent-blue);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .instruction {
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        /* 代码列表 */
        .code-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 300px;
        }

        .code-block {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 16px 20px;
            border-radius: 12px;
            cursor: grab;
            display: flex;
            align-items: center;
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        /* 左侧装饰条 */
        .code-block::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background: var(--accent-blue);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .code-block:hover::before { opacity: 1; }

        .code-block:hover {
            background: rgba(40, 40, 40, 0.8);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.2);
        }

        .code-block.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            background: transparent;
            border: 2px dashed var(--accent-blue);
            box-shadow: none;
            color: transparent;
        }
        .code-block.dragging * { visibility: hidden; } /* 隐藏拖动源的内容 */

        /* 放置时的占位效果 */
        .code-block.drag-over {
            border-top: 2px solid var(--accent-blue);
            margin-top: 5px;
        }

        /* 缩进处理 */
        .indent-0 { padding-left: 20px; }
        .indent-1 { padding-left: 45px; } /* 增加缩进使其更明显 */
        
        /* 手柄图标 */
        .drag-handle {
            margin-right: 15px;
            color: rgba(255,255,255,0.2);
            cursor: grab;
            transition: color 0.2s;
        }
        .code-block:hover .drag-handle { color: rgba(255,255,255,0.6); }

        /* 语法高亮 */
        .kwd { color: var(--c-keyword); }
        .func { color: var(--c-func); }
        .str { color: var(--c-string); }
        .num { color: var(--c-num); }
        .macro { color: var(--c-macro); }

        /* 终端窗口 */
        .terminal {
            background: #1a1b26;
            border-radius: 12px;
            border: 1px solid #333;
            overflow: hidden;
            margin-top: auto;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .terminal-bar {
            background: #24283b;
            padding: 8px 12px;
            display: flex;
            gap: 6px;
            border-bottom: 1px solid #333;
        }

        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot.red { background: #ff5f56; }
        .dot.yellow { background: #ffbd2e; }
        .dot.green { background: #27c93f; }

        .terminal-content {
            padding: 15px;
            height: 90px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            color: #a9b1d6;
            overflow-y: auto;
        }

        .term-success { color: var(--accent-green); }
        .term-error { color: var(--accent-red); }

        /* 按钮组 */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .btn {
            border: none;
            padding: 14px 32px;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn-run {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
        }
        
        .btn-run:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(118, 75, 162, 0.6);
        }

        .btn-next {
            background: #11998e;
            background: linear-gradient(to right, #11998e, #38ef7d);
            color: white;
            display: none;
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-next:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(56, 239, 125, 0.6); }

        /* 成功状态 Code Block */
        .code-block.success-state {
            background: rgba(0, 230, 118, 0.1);
            border-color: var(--accent-green);
        }
        .code-block.success-state::before { background: var(--accent-green); opacity: 1; }

        /* 动画 */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--accent-red); }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* 胜利全屏弹窗 */
        .victory-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 12, 41, 0.95);
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .victory-modal.active { opacity: 1; pointer-events: all; }
        
        .victory-content { text-align: center; animation: popIn 0.5s ease; }
        .trophy { font-size: 5rem; color: #ffd700; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5)); }
        .victory-title { font-size: 2.5rem; margin: 0; background: linear-gradient(to right, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    </style>
</head>
<body>

    <div class="ambient-light"></div>
    <div class="ambient-light"></div>

    <div class="app-container" id="app-box">
        <header>
            <div class="logo"><i class="fa-solid fa-code"></i> Code Mosaic</div>
            <div class="level-badge" id="level-display">LEVEL 1 / 4</div>
        </header>

        <p class="instruction">拖动代码块，像拼图一样重构 C 语言程序逻辑。</p>

        <ul class="code-list" id="code-list">
            </ul>

        <div class="terminal">
            <div class="terminal-bar">
                <div class="dot red"></div>
                <div class="dot yellow"></div>
                <div class="dot green"></div>
            </div>
            <div class="terminal-content" id="terminal-text">
                > GCC Compiler ready... waiting for source code.
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-run" onclick="verifyCode()">
                <i class="fa-solid fa-play"></i> Compile & Run
            </button>
            <button class="btn btn-next" id="btn-next" onclick="nextLevel()">
                Next Challenge <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div class="victory-modal" id="victory-modal">
        <div class="victory-content">
            <div class="trophy"><i class="fa-solid fa-trophy"></i></div>
            <h1 class="victory-title">MISSION ACCOMPLISHED</h1>
            <p style="color: #a0a0a0; margin-top: 10px; font-size: 1.1rem;">你的 C 语言逻辑无懈可击。</p>
            <button class="btn btn-run" style="margin-top: 30px;" onclick="location.reload()">Replay Game</button>
        </div>
    </div>

    <script>
        // --- 游戏核心数据 ---
        const levels = [
            {
                title: "The Beginning",
                indentPattern: [0, 0, 1, 1, 0], // 0=无缩进, 1=一级缩进
                snippets: [
                    { id: 1, html: '<span class="macro">#include</span> &lt;stdio.h&gt;' },
                    { id: 2, html: '<span class="kwd">int</span> <span class="func">main</span>() {' },
                    { id: 3, html: '<span class="func">printf</span>(<span class="str">"Hello World\\n"</span>);' },
                    { id: 4, html: '<span class="kwd">return</span> <span class="num">0</span>;' },
                    { id: 5, html: '}' }
                ],
                output: "Hello World"
            },
            {
                title: "Variables & Math",
                indentPattern: [0, 1, 1, 1, 1, 0],
                snippets: [
                    { id: 1, html: '<span class="kwd">int</span> <span class="func">main</span>() {' },
                    { id: 2, html: '<span class="kwd">int</span> a = <span class="num">5</span>;' },
                    { id: 3, html: '<span class="kwd">int</span> b = <span class="num">10</span>;' },
                    { id: 4, html: '<span class="kwd">int</span> sum = a + b;' },
                    { id: 5, html: '<span class="func">printf</span>(<span class="str">"%d"</span>, sum);' },
                    { id: 6, html: '}' }
                ],
                output: "15"
            },
            {
                title: "Decision Making",
                indentPattern: [0, 0, 1, 0, 1, 0],
                snippets: [
                    { id: 1, html: '<span class="kwd">int</span> hp = <span class="num">100</span>;' },
                    { id: 2, html: '<span class="kwd">if</span> (hp > <span class="num">0</span>) {' },
                    { id: 3, html: '<span class="func">printf</span>(<span class="str">"Alive"</span>);' },
                    { id: 4, html: '} <span class="kwd">else</span> {' },
                    { id: 5, html: '<span class="func">printf</span>(<span class="str">"Game Over"</span>);' },
                    { id: 6, html: '}' }
                ],
                output: "Alive"
            },
            {
                title: "The Loop",
                indentPattern: [0, 0, 1, 1, 0, 0],
                snippets: [
                    { id: 1, html: '<span class="kwd">int</span> i;' },
                    { id: 2, html: '<span class="kwd">for</span>(i=<span class="num">0</span>; i<<span class="num">3</span>; i++) {' },
                    { id: 3, html: '<span class="func">printf</span>(<span class="str">"%d "</span>, i);' },
                    { id: 4, html: '}' }, // 循环结束
                    { id: 5, html: '<span class="func">printf</span>(<span class="str">"Done"</span>);' },
                    { id: 6, html: '<span class="kwd">return</span> <span class="num">0</span>;' }
                ],
                output: "0 1 2 Done"
            }
        ];

        let currentIdx = 0;
        const listEl = document.getElementById('code-list');
        const termText = document.getElementById('terminal-text');
        const nextBtn = document.getElementById('btn-next');
        const appBox = document.getElementById('app-box');

        function loadLevel(idx) {
            currentIdx = idx;
            document.getElementById('level-display').innerText = `LEVEL ${idx + 1}`;
            nextBtn.style.display = 'none';
            termText.innerHTML = '> System initialized.<br>> Waiting for compilation...';
            listEl.innerHTML = '';

            // 准备数据：合并HTML和缩进信息，然后打乱
            const level = levels[idx];
            let items = level.snippets.map((s, i) => ({
                ...s,
                indent: level.indentPattern[i]
            }));

            // 随机打乱 (Fisher-Yates)
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }

            // 渲染
            items.forEach(item => {
                const li = document.createElement('li');
                // 初始渲染时，我们需要带上这个块“原本应该有”的缩进样式
                // 注意：这里有一个逻辑技巧，为了视觉上的拼图感，我们可以先不给缩进，或者给所有的块一个默认样式
                // 但为了更“所见即所得”，我们在这里给它加上正确的缩进类，让用户通过缩进提示来辅助排序
                li.className = `code-block indent-${item.indent}`;
                li.draggable = true;
                li.dataset.id = item.id;
                li.innerHTML = `<i class="fa-solid fa-grip-vertical drag-handle"></i> ${item.html}`;
                
                setupDrag(li);
                listEl.appendChild(li);
            });
        }

        // --- 现代拖拽逻辑 ---
        let dragSrc = null;

        function setupDrag(el) {
            el.addEventListener('dragstart', e => {
                dragSrc = el;
                el.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', el.innerHTML);
            });

            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
                document.querySelectorAll('.code-block').forEach(b => b.classList.remove('drag-over'));
            });

            el.addEventListener('dragover', e => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                el.classList.add('drag-over');
            });

            el.addEventListener('dragleave', () => {
                el.classList.remove('drag-over');
            });

            el.addEventListener('drop', e => {
                e.stopPropagation();
                el.classList.remove('drag-over');
                if (dragSrc !== el) {
                    // 交换 HTML 内容 (视觉)
                    const srcHTML = dragSrc.innerHTML;
                    dragSrc.innerHTML = el.innerHTML;
                    el.innerHTML = srcHTML;

                    // 交换 ID (逻辑)
                    const srcId = dragSrc.dataset.id;
                    dragSrc.dataset.id = el.dataset.id;
                    el.dataset.id = srcId;

                    // 交换 缩进样式 (视觉提示)
                    // 获取两个元素当前的缩进 class
                    const getIndent = (dom) => {
                        if(dom.classList.contains('indent-1')) return 'indent-1';
                        return 'indent-0';
                    };
                    const srcClass = getIndent(dragSrc);
                    const tgtClass = getIndent(el);
                    
                    // 移除旧的
                    dragSrc.classList.remove('indent-0', 'indent-1');
                    el.classList.remove('indent-0', 'indent-1');
                    
                    // 添加对方的
                    dragSrc.classList.add(tgtClass);
                    el.classList.add(srcClass);
                }
                return false;
            });
        }

        // --- 验证逻辑 ---
        function verifyCode() {
            const blocks = document.querySelectorAll('.code-block');
            let isCorrect = true;

            blocks.forEach((b, index) => {
                if (parseInt(b.dataset.id) !== index + 1) {
                    isCorrect = false;
                }
            });

            termText.innerHTML = '> gcc main.c -o app<br>> Compiling...<br>';

            if (isCorrect) {
                // 成功
                setTimeout(() => {
                    termText.innerHTML += `<span class="term-success">> Build Successful!</span><br>> Output: ${levels[currentIdx].output}`;
                    blocks.forEach(b => b.classList.add('success-state'));
                    nextBtn.style.display = 'flex';
                }, 600);
            } else {
                // 失败
                setTimeout(() => {
                    termText.innerHTML += `<span class="term-error">> Error: Syntax/Logical error detected.</span><br>> Please check sequence.`;
                    appBox.classList.add('shake');
                    setTimeout(() => appBox.classList.remove('shake'), 400);
                }, 600);
            }
        }

        function nextLevel() {
            if (currentIdx + 1 < levels.length) {
                loadLevel(currentIdx + 1);
            } else {
                document.getElementById('victory-modal').classList.add('active');
            }
        }

        // 启动
        loadLevel(0);

    </script>
</body>
</html>
